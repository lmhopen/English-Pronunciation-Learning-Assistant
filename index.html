<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>English Learning Tool</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .sentence-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .english-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .speak-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .speak-button:hover {
            background-color: #45a049;
        }
        .speak-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            padding: 10px;
            font-family: Arial, sans-serif;
        }
        button {
            background-color: #008CBA;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #007B9A;
        }
        .speed-control {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f8ff;
        }
        .speed-slider {
            width: 100%;
            margin: 10px 0;
        }
        .speed-value {
            display: inline-block;
            width: 40px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>English Learning Tool</h1>
    
    <!-- 语速控制区域 -->
    <div class="speed-control">
        <label for="speedSlider">发音速度: 
            <span id="speedValue" class="speed-value">1.0</span>x
        </label>
        <input type="range" id="speedSlider" class="speed-slider" 
               min="0.5" max="2.0" step="0.1" value="1.0"
               oninput="updateSpeedValue()">
    </div>
    
    <div>
        <textarea id="inputText" rows="10" cols="80" placeholder="请输入英文句子，每行一句..."></textarea><br><br>
        <button onclick="processText()">处理文本</button>
    </div>
    
    <div id="results"></div>

    <script>
        // 全局变量存储当前语速
        let currentSpeed = 1.0;
        let activeUtterances = new Map(); // 存储每个按钮对应的语音实例
        
        // 更新语速显示值
        function updateSpeedValue() {
            const slider = document.getElementById('speedSlider');
            const valueDisplay = document.getElementById('speedValue');
            currentSpeed = parseFloat(slider.value);
            valueDisplay.textContent = currentSpeed.toFixed(1);
        }
        
        function processText() {
            const inputText = document.getElementById('inputText').value;
            const sentences = inputText.split('\n').filter(sentence => sentence.trim() !== '');
            
            // 清空之前的结果
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // 显示每个句子
            sentences.forEach((sentence, index) => {
                const container = document.createElement('div');
                container.className = 'sentence-container';
                

                                // 判断是否为英文句子（包含英文字母且不以斜杠或方括号开头结尾）
                const isEnglishSentence = /[a-zA-Z]/.test(sentence) && 
                                        !/^\/.*\/$/.test(sentence) && 
                                        !/^\[.*\]$/.test(sentence);
                
                if (isEnglishSentence) {
                    // 创建英文文本元素
                    const textSpan = document.createElement('span');
                    textSpan.textContent = sentence;
                    
                    // 创建发音按钮
                    const speakButton = document.createElement('button');
                    speakButton.className = 'speak-button';
                    speakButton.textContent = '🔊 发音';
                    speakButton.onclick = function() {
                        speakText(sentence, speakButton); // 传递按钮引用
                    };
                    // 创建包含文本和按钮的容器
                    const englishTextDiv = document.createElement('div');
                    englishTextDiv.className = 'english-text';
                    englishTextDiv.appendChild(textSpan);
                    englishTextDiv.appendChild(speakButton);
                    
                    container.appendChild(englishTextDiv);
                } else {
                    // 对于非英文行（中文翻译或音标），只显示文本
                    const textDiv = document.createElement('div');
                    textDiv.className = 'english-text';
                    textDiv.textContent = sentence;
                    container.appendChild(textDiv);
                }
                
                resultsDiv.appendChild(container);
            });
        }
        
        function speakText(text, button) {
            // 检查浏览器是否支持语音合成
            if ('speechSynthesis' in window) {
                const buttonKey = text; // 使用文本作为唯一标识
                
                // 如果当前有正在播放的语音
                if (activeUtterances.has(buttonKey)) {
                    const utterance = activeUtterances.get(buttonKey);
                    
                    // 如果正在播放，则暂停
                    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
                        window.speechSynthesis.pause();
                        button.textContent = '▶ 继续';
                        return;
                    }
                    // 如果已暂停，则继续播放
                    else if (window.speechSynthesis.paused) {
                        window.speechSynthesis.resume();
                        button.textContent = '⏸ 暂停';
                        return;
                    }
                }
                
                // 如果没有正在播放的语音，或者播放已完成，则创建新的语音实例
                window.speechSynthesis.cancel(); // 取消其他语音
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // 设置语音参数
                utterance.lang = 'en-US';      // 设置为英语
                utterance.rate = currentSpeed; // 使用可调节的语速
                utterance.pitch = 1;           // 音调
                
                // 语音开始时更新按钮文本
                utterance.onstart = function() {
                    button.textContent = '⏸ 暂停';
                };
                
                // 语音结束或取消时清理状态
                utterance.onend = function() {
                    activeUtterances.delete(buttonKey);
                    button.textContent = '🔊 发音';
                };
                
                utterance.onerror = function() {
                    activeUtterances.delete(buttonKey);
                    button.textContent = '🔊 发音';
                };
                
                // 存储语音实例
                activeUtterances.set(buttonKey, utterance);
                
                // 播放语音
                window.speechSynthesis.speak(utterance);
            } else {
                alert('您的浏览器不支持语音合成功能');
            }
        }
        
        // 页面加载完成后初始化语速值显示
        window.onload = function() {
            updateSpeedValue();
            
            // 页面卸载时清理语音
            window.addEventListener('beforeunload', function() {
                window.speechSynthesis.cancel();
            });
        };
    </script>
</body>
</html>